function reloadSession(e){var r=$.Deferred();return e.sessionStore.sessions[e.sessionID]?(e.session.reload(function(){r.resolve()}),r):(r.resolve(),r)}function handler(e,r,s){function t(s){var t=s.message||s,n={error:t,url:e.url};t.startsWith("ERR")||t.startsWith("MES")||Db.insert("errors",{_id:(new Date).getTime(),playerId:session.player._id,side:"server",message:s.message||s,stack:s.stack}),r.jsonp(JSON.stringify(n))}function n(s){var t={data:s||!0,url:e.url};r.jsonp(JSON.stringify(t))}reloadSession(e).then(function(){try{var r=require("./routes/auth"),i=e.session;if(s!==r&&!i.player)throw"ERR_UNAUTH";var o=getMethodName(e,s),a=s[o];if(!a)return void t("Method "+o+" is not exists");var u=getParams(e,a);a.handler(i,u).then(function(r){require("./controllers/ach").handler(i,r,e),i.isDirty?(i.isDirty=!1,i.save(function(){n(r)}),Player.update(i.player._id,i.player)):n(r)},t)}catch(d){t(d)}})}function getMethodName(e,r){for(var s in e.query)if("method"===s)return e.query[s];return"default"}function getParams(e,r){var s={};if(!r.params)return s;for(var t in r.params){var n=r.params[t],i=e.query[t];if(n.required&&void 0===i)throw ERR_PARAMS;n.parseMethod&&(i=n.parseMethod(i)),s[t]=i}return s}var Express=require("express"),Db=require("./db"),Compression=require("compression"),Session=require("express-session"),GymDb=require("./gymdb/gymdb"),$=require("jquery-deferred"),Player=require("./controllers/player");exports.start=function(e){var r=Express();r.use(Compression()),r.use(Session({genid:function(e){var r=e.query.playerId;return r},secret:"iuBviX21"}));var s=["auth","refs","workout","job","self","top","coach","buy","real","god","payment","inv","error"];return $.Deferred(function(t){try{GymDb.init(GLOBAL.GYM.instance).then(function(){s.forEach(function(e){var s=require("./routes/"+e);r.get("/"+e,function(e,r){handler(e,r,s)})}),r.listen(e),t.resolve()},t.reject)}catch(n){t.reject(n)}})};