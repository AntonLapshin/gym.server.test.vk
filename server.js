function reloadSession(e){var r=$.Deferred();return e.sessionStore.sessions[e.sessionID]?(e.session.reload(function(){r.resolve()}),r):(r.resolve(),r)}function handler(e,r,n){function s(n){var s={error:n.message||n,url:e.url};r.jsonp(JSON.stringify(s))}function t(n){var s={data:n||!0,url:e.url};r.jsonp(JSON.stringify(s))}reloadSession(e).then(function(){try{var r=require("./routes/auth"),o=e.session;if(n!==r&&!o.player)throw"ERR_UNAUTH";var i=getMethodName(e,n),a=n[i];if(!a)return void s("Method "+i+" is not exists");var u=getParams(e,a);a.handler(o,u).then(function(r){require("./controllers/ach").handler(o,r,e),o.isDirty?(o.isDirty=!1,o.save(function(){t(r)}),Player.update(o.player._id,o.player)):t(r)},s)}catch(f){s(f)}})}function getMethodName(e,r){for(var n in e.query)if("method"===n)return e.query[n];return"default"}function getParams(e,r){var n={};if(!r.params)return n;for(var s in r.params){var t=r.params[s],o=e.query[s];if(t.required&&void 0===o)throw ERR_PARAMS;t.parseMethod&&(o=t.parseMethod(o)),n[s]=o}return n}var Express=require("express"),Compression=require("compression"),Session=require("express-session"),GymDb=require("./gymdb/gymdb"),$=require("jquery-deferred"),Player=require("./controllers/player");exports.start=function(e){var r=Express();r.use(Compression()),r.use(Session({genid:function(e){var r=e.query.playerId;return r},secret:"iuBviX21"}));var n=["auth","refs","workout","job","self","top","coach","buy","real","god","payment","inv"];return $.Deferred(function(s){try{GymDb.init(GLOBAL.GYM.instance).then(function(){n.forEach(function(e){var n=require("./routes/"+e);r.get("/"+e,function(e,r){handler(e,r,n)})}),r.listen(e),s.resolve()},s.reject)}catch(t){s.reject(t)}})};