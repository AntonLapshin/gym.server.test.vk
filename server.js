function reloadSession(e){var r=$.Deferred();return e.sessionStore.sessions[e.sessionID]?(e.session.reload(function(){r.resolve()}),r):(r.resolve(),r)}function handler(e,r,s){function n(s){var n={error:s.message||s,url:e.url};r.jsonp(JSON.stringify(n))}function o(s){var n={data:s||!0,url:e.url};r.jsonp(JSON.stringify(n))}reloadSession(e).then(function(){var r=require("./routes/auth"),t=e.session;if(s!==r&&!t.player)throw"ERR_UNAUTH";var i=getMethodName(e,s),a=s[i];if(!a)return void n("Method "+i+" is not exists");var u=getParams(e,a);a.handler(t,u).then(function(r){require("./controllers/ach").handler(t,r,e),t.isDirty?(t.isDirty=!1,t.save(function(){o(r)}),Player.update(t.player._id,t.player)):o(r)},n)})}function getMethodName(e,r){for(var s in e.query)if("method"===s)return e.query[s];return"default"}function getParams(e,r){var s={};if(!r.params)return s;for(var n in r.params){var o=r.params[n],t=e.query[n];if(o.required&&void 0===t)throw ERR_PARAMS;o.parseMethod&&(t=o.parseMethod(t)),s[n]=t}return s}var Express=require("express"),Compression=require("compression"),Session=require("express-session"),GymDb=require("./gymdb/gymdb"),$=require("jquery-deferred"),Player=require("./controllers/player");exports.start=function(e,r,s,n){exports.vkapp=s,exports.CHECK_LEVELUP_PERIOD=n;var o=Express();o.use(Compression()),o.use(Session({genid:function(e){var r=e.query.playerId;return r},secret:"iuBviX21"}));var t=["auth","refs","workout","job","self","top","coach","buy","real","god","payment"];return $.Deferred(function(s){try{GymDb.init(r).then(function(){t.forEach(function(e){var r=require("./routes/"+e);o.get("/"+e,function(e,s){handler(e,s,r)})}),o.listen(e),s.resolve()},s.reject)}catch(n){s.reject(n)}})};