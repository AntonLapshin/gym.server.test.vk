function getStress(e){for(var r=function(){for(var e=Db.getRefs().muscles,r=0,t=0;t<e.length;t++)r+=e[t].power;return r},t=r(),a=0,l=0;l<e["private"].body.length;l++){var s=e["private"].body[l],i=Db.getRefs().muscles,o=i[s._id];a+=o.power*s.stress/t}return a}function update(e){var r=module.exports.getRegen(e),t=new Date,a=DateHelper.intervalHours(Date.parse(t)-Date.parse(new Date(e["private"].reg.lastUpdateTime))),l=$.round(r.frazzle*a),s=Math.round(e["private"].energy+r.energy*a);s>PlayersCollection.ENERGY_MAX&&(s=PlayersCollection.ENERGY_MAX),e["private"].energy=s,e["private"].reg.lastUpdateTime=t.getTime();for(var i=0;i<e["private"].body.length;i++){var o=e["private"].body[i];o.frazzle=$.round(o.frazzle-l),o.frazzle<0&&(o.frazzle=0)}}function getLevelChange(e){var r=new Date;if(e["public"].level>0||e["private"].achievements.length<6){var t=DateHelper.addHoursClone(new Date(e["private"].reg.lastCheckLevelUpTime),CHECK_LEVELUP_PERIOD);if(t>r)return 0}e["private"].reg.lastCheckLevelUpTime=r.getTime();var a,l=module.exports.getPlayerStat(e),s=Math.random()<l.levelUp;if(s?e["public"].level++:(a=Math.random()<l.levelDown,a&&e["public"].level--),s||a)for(i=0;i<e["private"].body.length;i++)e["private"].body[i].frazzle=0,e["private"].body[i].stress=0;return e["private"].rest=[],e["private"].food=[],e["private"].stimul=[],s?1:a?-1:0}var Db=require("../db"),DateHelper=require("../controllers/date"),PlayersCollection=require("../gymdb/collections/players"),Player=require("../controllers/player"),$=require("jquery-deferred"),curve=require("../controllers/curve"),UPDATE_PERIOD=1,CHECK_LEVELUP_PERIOD=2,REG_FRAZZLE_PER_HOUR=1,REG_ENERGY=1,REG_ENERGY_PER_HOUR=REG_ENERGY*PlayersCollection.ENERGY_MAX,MAX_LEVEL=67;module.exports={getPlayerStat:function(e){function r(e,r,t){var a=r*t,l=3*e;return l/a}for(var t=e["public"].level,a=getStress(e),l=curve.getMass(t),s=0,i=0,o=0,n=0;n<e["private"].food.length;n++){var p=e["private"].food[n],v=Db.getRefs().shop[0].items[p];s+=v.carbs,i+=v.fats,o+=v.proteins}var u=curve.getFoodProfit("carbs",r(s,l,6)),p=curve.getFoodProfit("fats",r(i,l,1)),f=curve.getFoodProfit("proteins",r(o,l,2.5)),d=(u+p+f)/3;d>1&&(d=1);for(var c=0,n=0;n<e["private"].rest.length;n++){var g=e["private"].rest[n],E=Db.getRefs().shop[1].items[g];c+=E.coeff}c>1&&(c=1);for(var h=0,n=0;n<e["private"].stimul.length;n++){var y=e["private"].stimul[n],D=Db.getRefs().shop[2].items[y];h+=D.growth}h>.3&&(h=.3),d=.3+.7*d,c=.4+.6*c,h=1+h;var R=1-curve.getLevelFading(t);t===MAX_LEVEL&&(R=0);var m=a*c*d*h;m>1&&(m=1),m*=R,0===t&&c>0&&a>0&&d>0&&(m=1);var b=1===m||0===t?0:1-m;return b=b>.3?0:.2*b,{period:"each "+CHECK_LEVELUP_PERIOD+" hours",levelUp:m,levelDown:b,stress:a,rest:c,food:d,stimul:h,fading:R,foodDetails:{carbs:u,fats:p,proteins:f}}},getRegen:function(e){for(var r=0,t=0;t<e["private"].rest.length;t++){var a=e["private"].rest[t],l=Db.getRefs().shop[1].items[a];r+=l.coeff}r>1&&(r=1),r=.5*r;for(var s=0,t=0;t<e["private"].stimul.length;t++){var i=e["private"].stimul[t],o=Db.getRefs().shop[2].items[i];s+=o.regen}return s>.5&&(s=.5),{energy:(REG_ENERGY+r+s)*PlayersCollection.ENERGY_MAX,frazzle:REG_FRAZZLE_PER_HOUR+r+s}},get:{params:{bill:{parseMethod:parseFloat},friends:{parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),a=e.player;r.bill&&a["private"].coach.hired&&(a["private"].coach.bill=r.bill,e.isDirty=!0),r.friends&&(a["private"].friends=r.friends,e.isDirty=!0);var l=new Date,s=a["private"].reg,i=DateHelper.addMinutesClone(new Date(s.lastUpdateTime),UPDATE_PERIOD);if(i>l)return t.resolve({success:!0,player:a}),t;update(a);var o=getLevelChange(a);return e.isDirty=!0,t.resolve({success:!0,player:a,levelChange:o}),t}},getPlayer:{params:{playerId:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred();return Player.find(r.playerId,["_id","public"]).then(function(e){t.resolve({success:!0,player:e})}),t}},getPlayers:{params:{playerIds:{required:!0,parseMethod:function(e){var r=[];return e.split(",").forEach(function(e){r.push(parseInt(e))}),r}}},handler:function(e,r){var t=$.Deferred();return Player.getPlayers(r.playerIds).then(function(e){t.resolve({success:!0,players:e})}),t}}};