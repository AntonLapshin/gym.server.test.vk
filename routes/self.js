function getStress(e){for(var r=Db.getRefs().muscles,t=function(){for(var e=0,t=0;t<r.length;t++)e+=r[t].power;return e},a=t(),l=0,n=0;n<e["private"].body.length;n++){var i=e["private"].body[n],o=r[i._id];l+=o.power*i.stress/a}return l}function update(e){var r=module.exports.getRegen(e);0==r.frazzle&&(r.frazzle=.3),0==r.energy&&(r.energy=.3);var t=new Date,a=DateHelper.intervalHours(Date.parse(t)-Date.parse(new Date(e["private"].reg.lastUpdateTime))),l=$.round(r.frazzle*a),n=$.round(r.tonus*a),i=$.round(e["private"].energy+r.energy*a);i>PlayersCollection.ENERGY_MAX&&(i=PlayersCollection.ENERGY_MAX),e["private"].garb+=Math.round(r.garb*a),e["private"].garb>GARB_MAX&&(e["private"].garb=GARB_MAX),e["private"].energy=i,e["private"].reg.lastUpdateTime=t.getTime();for(var o=0;o<e["private"].body.length;o++){var s=e["private"].body[o];s.frazzle=$.round(s.frazzle-l),s.frazzle<0&&(s.frazzle=0),e["private"].tonus&&(e["private"].tonus[o]=$.round(e["private"].tonus[o]-n),e["private"].tonus[o]<0&&(e["private"].tonus[o]=0))}}function getLevelChange(e){var r=new Date,t=module.exports.getPlayerStat(e),a=Curve.getLevelRequirements(e["public"].level),l=(e["private"].growth||e["private"].growt||0)+t.growth;if(e["public"].level>0&&a>l){var n=DateHelper.addHoursClone(new Date(e["private"].reg.lastCheckLevelUpTime),GLOBAL.GYM.CHECK_LEVELUP_PERIOD);if(n>r)return-2}e["private"].reg.lastCheckLevelUpTime=r.getTime();var i=0;if(l>=a)e["public"].level++,e["private"].growth=0,e["private"].energy=PlayersCollection.ENERGY_MAX,i=1;else{if(0===e["public"].level)return-2;e["private"].growth=l}return e["private"].body.forEach(function(e){e.frazzle=0,e.stress=0}),e["private"].rest=[],e["private"].food=[],e["private"].stimul=[],0===i&&0===e["public"].level?-2:i}var Db=require("../db"),DateHelper=require("../controllers/date"),PlayersCollection=require("../gymdb/collections/players"),Player=require("../controllers/player"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),MAX_LEVEL=67,GARB_MAX=14,BONUS_MAX=10;module.exports={getPlayerStat:function(e){for(var r=e["public"].level,t=getStress(e),a=(Curve.getMass(r),Stimul.getFood(e)),l=0,n=0;n<e["private"].rest.length;n++){var i=e["private"].rest[n],o=Db.getRefs().shop[1].items[i];o&&(l+=o.coeff)}l>1&&(l=1);var s=1+Stimul.getGrowth(e),p=t*l*a*s;return{period:"each "+GLOBAL.GYM.CHECK_LEVELUP_PERIOD+" hours",growth:p,stress:t,rest:l,food:a,stimulGrowth:s}},getRegen:function(e){for(var r=0,t=0;t<e["private"].rest.length;t++){var a=e["private"].rest[t],l=Db.getRefs().shop[1].items[a];l&&(r+=l.coeff)}r>1&&(r=1);var n=Stimul.getRegen(e),i={energy:GLOBAL.GYM.REG_ENERGY*(r+n)*PlayersCollection.ENERGY_MAX,frazzle:GLOBAL.GYM.REG_FRAZZLE*(r+n),tonus:GLOBAL.GYM.REG_TONUS,garb:GLOBAL.GYM.REG_GARB};return i.energy<GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX&&(i.energy=GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX),i.frazzle<GLOBAL.GYM.REG_FRAZZLE_SLOW&&(i.frazzle=GLOBAL.GYM.REG_FRAZZLE_SLOW),i},get:{params:{friends:{parseMethod:parseInt},garb:{parseMethod:parseInt},bonus:{parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),a=e.player;r.bonus&&(a["private"].money+=Math.min(r.bonus,BONUS_MAX),e.isDirty=!0),r.garb&&(a["private"].garb-=r.garb,a["private"].garb<0&&(a["private"].garb=0),e.isDirty=!0),r.friends&&(a["private"].friends=r.friends,e.isDirty=!0);var l=new Date,n=a["private"].reg,i=DateHelper.addMinutesClone(new Date(n.lastUpdateTime),GLOBAL.GYM.UPDATE_PERIOD);if(i>l)return t.resolve({success:!0,player:a}),t;var o={success:!0,player:a};if(i.getDay()!=l.getDay()){var s=Rank.getSalary(a);s&&(o.money=s.money,a["private"].money+=s.money,s.gold>0&&(o.gold=s.gold,a["private"].gold+=s.gold))}update(a);var p=getLevelChange(a);if(1===p){var u=Rank.update(a);null!==u&&(o.rank=u)}return e.isDirty=!0,-2!=p&&(o.levelChange=p),t.resolve(o),t}},getPlayer:{params:{playerId:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred();return Player.find(r.playerId,{_id:1,"public":1}).then(function(e){t.resolve({success:!0,player:e})}),t}},getPlayers:{params:{playerIds:{required:!0,parseMethod:function(e){var r=[];return e.split(",").forEach(function(e){r.push(parseInt(e))}),r}}},handler:function(e,r){var t=$.Deferred();return Player.getPlayers(r.playerIds).then(function(e){t.resolve({success:!0,players:e})}),t}}};