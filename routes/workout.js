function getTonus(e){if(!e["private"].tonus){e["private"].tonus=[];for(var r=0;16>r;r++)e["private"].tonus.push(0)}return e["private"].tonus}function setFrazzle(e,r,t){var a=getTonus(e);r.body.forEach(function(r,s){var i=e["private"].body[r._id],n=i.frazzle+r.stress*t;n>1&&(n=1);var u=i.stress+(r.stress<.5?r.stress/2:r.stress)*t;u>1&&(u=1);var o=a[s]+.03*u;o-=a[s]/3*(.03*u),o>3&&(o=3),e["private"].body[r._id].frazzle=$.round(n),e["private"].body[r._id].stress=$.round(u),a[s]=$.round(o)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),Coach=require("../controllers/coach"),Rank=require("../controllers/rank"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=e["private"].tonus,i=Db.getRefs().exercises[r],n=curve.getWeightMax(t,r),u=0,o=0;o<e["private"].stimul.length;o++){var p=e["private"].stimul[o],f=Db.getRefs().shop[2].items[p];u+=f.power}u>1&&(u=1),u/=5;for(var c=0,v=0,d=0,o=0;o<i.body.length;o++){var l=i.body[o],E=a[l._id],g=Db.getRefs().muscles[l._id],M=s?s[l._id]:0,h=g.power*l.stress,y=h*E.frazzle;c+=h,v+=y,d+=M*g.power/5}var _=v/c*.1,x=n+n*u-n*_+n*d*.1;return x},getRepeatsAndEff:function(e,r,t,a){var s=curve.getRepeatsMax(e["public"].level,r,t,a),i=curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,s=r.rate,i=r.eff;if(a["private"].money<s)return t.resolve({success:!1}),t;var n={success:!0},u=a["private"].energy/a["private"].energyMax;i=u*i;var o=getTonus(a);return a["private"].body.forEach(function(e,r){e.frazzle+=$.round(i),e.stress+=$.round(i),e.frazzle>1&&(e.frazzle=1),e.stress>1&&(e.stress=1);var t=o[r]+.015*e.stress;t-=o[r]/3*(.015*e.stress),t>3&&(t=3),o[r]=$.round(t)}),e.isDirty=!0,n.effect=i,n.energy=-a["private"].energy,n.money=-s,a["private"].energy=0,Coach.earn(a["private"].coach,s),t.resolve(n),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,n=r.repeats,u=$.Deferred(),o=Db.getRefs().gyms[a];if(-1==o.exercises.indexOf(s))return u.reject("MES_EXERCISE"),u;var p=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===p.length)return u.reject("MES_EXERCISE"),u;p=p[0];var f=Db.getRefs().exercises[s],c=f.max*o.weight;if(WEIGHT_MIN>i||i>c)return u.reject("MES_WEIGHT"),u;if(REPEATS_MIN>n)return u.reject("MES_REPEATS_MIN"),u;if(n>REPEATS_MAX)return u.reject("MES_REPEATS_MAX"),u;var v={success:!0,id:s,weight:i,plan:n},d=module.exports.getTotalWeightMax(t,s);if(i>d&&f.energy>t["private"].energy)return u.reject("MES_ENERGY"),u;var l,E,g=module.exports.getRepeatsAndEff(t,s,i,d),M=n>0?n:g.repeatsMax,h=Math.floor(M<g.repeatsMax?M:g.repeatsMax);if(i>d)E=.5,l=f.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),l=Math.ceil(h/g.repeatsMax*f.energy),l>t["private"].energy)return u.reject("MES_ENERGY"),u;var y=g.weightEffect*repeatsEffect*.3*(h/g.repeatsMax);if(v.effect=y,v.fact=g.repeatsMax,v.energy=-l,h>=1){var _=p.pr||0;if(i>_){p&&(p.pr=i);var x=Rank.update(t);null!==x&&(v.rank=x),v.pr=!0}var R=f.wr;i>(R?R.value:0)&&(f.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:f.wr}}),v.wr=!0)}return t["private"].energy-=l,setFrazzle(t,f,y),e.isDirty=!0,u.resolve(v),u}}};