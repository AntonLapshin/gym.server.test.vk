function setFrazzle(e,r,t){r.body.forEach(function(r){var a=e["private"].body[r._id],s=a.frazzle+r.stress*t;s>1&&(s=1);var i=a.stress+r.stress*t;i>1&&(i=1),e["private"].body[r._id].frazzle=$.round(s),e["private"].body[r._id].stress=$.round(i)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=Db.getRefs().exercises[r],i=curve.getWeightMax(t,r),p=0,u=0;u<e["private"].stimul.length;u++){var f=e["private"].stimul[u],n=Db.getRefs().shop[2].items[f];p+=n.power}p>.5&&(p=.5),p/=5;for(var E=0,d=0,u=0;u<s.body.length;u++){var c=s.body[u],o=a[c._id],v=Db.getRefs().muscles[c._id],g=v.power*c.stress,l=g*o.frazzle;E+=g,d+=l}var M=d/E*.1,_=i+i*p-i*M;return _},getRepeatsAndEff:function(e,r,t,a){var s=curve.getRepeatsMax(e["public"].level,r,t,a),i=curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,p=r.repeats,u=$.Deferred(),f=Db.getRefs().gyms[a];if(-1==f.exercises.indexOf(s))return u.reject("MES_EXERCISE"),u;var n=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===n.length)return u.reject("MES_EXERCISE"),u;n=n[0];var E=Db.getRefs().exercises[s],d=E.max*f.weight;if(WEIGHT_MIN>i||i>d)return u.reject("MES_WEIGHT"),u;if(REPEATS_MIN>p)return u.reject("MES_REPEATS_MIN"),u;if(p>REPEATS_MAX)return u.reject("MES_REPEATS_MAX"),u;var c={success:!0,id:s,weight:i,plan:p},o=module.exports.getTotalWeightMax(t,s);if(i>o&&E.energy>t["private"].energy)return u.reject("MES_ENERGY"),u;var v,g,l=module.exports.getRepeatsAndEff(t,s,i,o),M=p>0?p:l.repeatsMax,_=Math.floor(M<l.repeatsMax?M:l.repeatsMax);if(i>o)g=.5,v=E.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),v=Math.round(_/l.repeatsMax*E.energy),v>t["private"].energy)return u.reject("MES_ENERGY"),u;var x=l.weightEffect*repeatsEffect*.3;if(c.fact=l.repeatsMax,c.energy=-v,_>=1){var R=n.pr||0;i>R&&(n&&(n.pr=i),c.pr=!0);var h=E.wr;i>(h?h.value:0)&&(E.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:E.wr}}),c.wr=!0)}return t["private"].energy-=v,setFrazzle(t,E,x),e.isDirty=!0,u.resolve(c),u}}};