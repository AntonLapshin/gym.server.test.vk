function setFrazzle(e,r,t){r.body.forEach(function(r){var s=e["private"].body[r._id],a=s.frazzle+r.stress*t;a>1&&(a=1);var i=s.stress+(r.stress<.5?r.stress/2:r.stress)*t;i>1&&(i=1),e["private"].body[r._id].frazzle=$.round(a),e["private"].body[r._id].stress=$.round(i)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,s=e["private"].body,a=Db.getRefs().exercises[r],i=curve.getWeightMax(t,r),p=0,f=0;f<e["private"].stimul.length;f++){var u=e["private"].stimul[f],E=Db.getRefs().shop[2].items[u];p+=E.power}p>1&&(p=1),p/=5;for(var n=0,c=0,f=0;f<a.body.length;f++){var d=a.body[f],o=s[d._id],v=Db.getRefs().muscles[d._id],g=v.power*d.stress,l=g*o.frazzle;n+=g,c+=l}var M=c/n*.1,_=i+i*p-i*M;return _},getRepeatsAndEff:function(e,r,t,s){var a=curve.getRepeatsMax(e["public"].level,r,t,s),i=curve.getRepeatsEffect(a);return{repeatsMax:a,weightEffect:i}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,s=r.gymId,a=r.exerciseId,i=r.weight,p=r.repeats,f=$.Deferred(),u=Db.getRefs().gyms[s];if(-1==u.exercises.indexOf(a))return f.reject("MES_EXERCISE"),f;var E=$.grep(t["public"].exercises,function(e){return e._id===a});if(0===E.length)return f.reject("MES_EXERCISE"),f;E=E[0];var n=Db.getRefs().exercises[a],c=n.max*u.weight;if(WEIGHT_MIN>i||i>c)return f.reject("MES_WEIGHT"),f;if(REPEATS_MIN>p)return f.reject("MES_REPEATS_MIN"),f;if(p>REPEATS_MAX)return f.reject("MES_REPEATS_MAX"),f;var d={success:!0,id:a,weight:i,plan:p},o=module.exports.getTotalWeightMax(t,a);if(i>o&&n.energy>t["private"].energy)return f.reject("MES_ENERGY"),f;var v,g,l=module.exports.getRepeatsAndEff(t,a,i,o),M=p>0?p:l.repeatsMax,_=Math.floor(M<l.repeatsMax?M:l.repeatsMax);if(i>o)g=.5,v=n.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),v=Math.ceil(_/l.repeatsMax*n.energy),v>t["private"].energy)return f.reject("MES_ENERGY"),f;var x=l.weightEffect*repeatsEffect*.3*(_/l.repeatsMax);if(d.fact=l.repeatsMax,d.energy=-v,_>=1){var R=E.pr||0;i>R&&(E&&(E.pr=i),d.pr=!0);var h=n.wr;i>(h?h.value:0)&&(n.wr={value:i,_id:t._id},Db.update("exercises",a,{$set:{wr:n.wr}}),d.wr=!0)}return t["private"].energy-=v,setFrazzle(t,n,x),e.isDirty=!0,f.resolve(d),f}}};