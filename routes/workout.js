function getTonus(e){if(!e["private"].tonus){e["private"].tonus=[];for(var r=0;16>r;r++)e["private"].tonus.push(0)}return e["private"].tonus}function setFrazzle(e,r,t){var a=getTonus(e);r.body.forEach(function(r,s){var i=e["private"].body[r._id],n=i.frazzle+r.stress*t;n>1&&(n=1);var u=i.stress+(r.stress<.5?r.stress/2:r.stress)*t;u>1&&(u=1);var o=.03*u;o-=o*(a[s]/TONUS_MAX),a[s]+=$.round(o),a[s]>TONUS_MAX&&(a[s]=TONUS_MAX),e["private"].body[r._id].frazzle=$.round(n),e["private"].body[r._id].stress=$.round(u)})}var Db=require("../db"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Coach=require("../controllers/coach"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10,TONUS_MAX=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=e["private"].tonus,i=Db.getRefs().exercises[r],n=Curve.getWeightMax(t,r),u=Stimul.getPower(e),o=0,p=0,f=0,c=0;c<i.body.length;c++){var d=i.body[c],v=a[d._id],l=Db.getRefs().muscles[d._id],E=s?s[d._id]:0,g=l.power*d.stress,M=g*v.frazzle,_=g*E;o+=g,p+=M,f+=_}var y=p/o,s=f/o,h=n+.1*n*u-.1*n*y+.1*n*s;return h},getRepeatsAndEff:function(e,r,t,a){var s=Curve.getRepeatsMax(e["public"].level,r,t,a),i=Curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,s=r.rate,i=r.eff;if(a["private"].money<s)return t.resolve({success:!1}),t;var n={success:!0},u=a["private"].energy/a["private"].energyMax;i=u*i;var o=getTonus(a);return a["private"].body.forEach(function(e,r){e.frazzle+=$.round(i),e.stress+=$.round(i),e.frazzle>1&&(e.frazzle=1),e.stress>1&&(e.stress=1);var t=.015*i;t-=t*(o[r]/TONUS_MAX),o[r]+=$.round(t),o[r]>TONUS_MAX&&(o[r]=TONUS_MAX)}),e.isDirty=!0,n.effect=i,n.energy=-a["private"].energy,n.money=-s,a["private"].energy=0,Coach.earn(a["private"].coach,s),t.resolve(n),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,n=r.repeats,u=$.Deferred(),o=Db.getRefs().gyms[a];if(-1==o.exercises.indexOf(s))return u.reject("MES_EXERCISE"),u;var p=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===p.length)return u.reject("MES_EXERCISE"),u;p=p[0];var f=Db.getRefs().exercises[s],c=f.max*o.weight;if(WEIGHT_MIN>i||i>c)return u.reject("MES_WEIGHT"),u;if(REPEATS_MIN>n)return u.reject("MES_REPEATS_MIN"),u;if(n>REPEATS_MAX)return u.reject("MES_REPEATS_MAX"),u;var d={success:!0,id:s,weight:i,plan:n},v=module.exports.getTotalWeightMax(t,s);if(i>v&&f.energy>t["private"].energy)return u.reject("MES_ENERGY"),u;var l,E,g=module.exports.getRepeatsAndEff(t,s,i,v),M=n>0?n:g.repeatsMax,_=Math.floor(M<g.repeatsMax?M:g.repeatsMax);if(i>v)E=.5,l=f.energy;else if(E=Curve.getRepeatsEffect(M),l=Math.ceil(_/g.repeatsMax*f.energy),l>t["private"].energy)return u.reject("MES_ENERGY"),u;var y=g.weightEffect*E*.3*(_/g.repeatsMax);if(d.effect=y,d.fact=g.repeatsMax,d.energy=-l,_>=1){var h=p.pr||0;if(i>h){p&&(p.pr=i);var x=Rank.update(t);null!==x&&(d.rank=x),d.pr=!0}var S=f.wr;i>(S?S.value:0)&&(f.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:f.wr}}),d.wr=!0)}return t["private"].energy-=l,setFrazzle(t,f,y),e.isDirty=!0,u.resolve(d),u}}};