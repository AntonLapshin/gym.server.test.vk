function getTonus(e){if(!e["private"].tonus){e["private"].tonus=[];for(var r=0;16>r;r++)e["private"].tonus.push(0)}return e["private"].tonus}function setFrazzle(e,r,t){var a=getTonus(e);r.body.forEach(function(r,s){var i=e["private"].body[r._id],n=i.frazzle+r.stress*t;n>1&&(n=1);var o=i.stress+(r.stress<.5?r.stress/2:r.stress)*t;o>1&&(o=1);var u=a[s]+.05*o;u-=a[s]/3*(.05*o),u>3&&(u=3),e["private"].body[r._id].frazzle=$.round(n),e["private"].body[r._id].stress=$.round(o),a[s]=$.round(u)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),Coach=require("../controllers/coach"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=e["private"].tonus,i=Db.getRefs().exercises[r],n=curve.getWeightMax(t,r),o=0,u=0;u<e["private"].stimul.length;u++){var p=e["private"].stimul[u],f=Db.getRefs().shop[2].items[p];o+=f.power}o>1&&(o=1),o/=5;for(var c=0,v=0,d=0,u=0;u<i.body.length;u++){var E=i.body[u],l=a[E._id],g=Db.getRefs().muscles[E._id],M=s?s[E._id]:0,h=g.power*E.stress,y=h*l.frazzle;c+=h,v+=y,d+=M*g.power/5}var _=v/c*.1,x=n+n*o-n*_+n*d*.1;return x},getRepeatsAndEff:function(e,r,t,a){var s=curve.getRepeatsMax(e["public"].level,r,t,a),i=curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,i=r.rate,n=r.eff;if(a["private"].money<i)return t.resolve({success:!1}),t;var o={success:!0},u=a["private"].energy/a["private"].energyMax;n=u*n;var p=getTonus(a);return a["private"].body.forEach(function(e,r){e.frazzle+=$.round(n),e.stress+=$.round(n),e.frazzle>1&&(e.frazzle=1),e.stress>1&&(e.stress=1);var t=p[r]+.03*e.stress;t-=p[r]/3*(.03*s),t>3&&(t=3),p[r]=$.round(t)}),e.isDirty=!0,o.effect=n,o.energy=-a["private"].energy,o.money=-i,a["private"].energy=0,Coach.earn(a["private"].coach,i),t.resolve(o),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,n=r.repeats,o=$.Deferred(),u=Db.getRefs().gyms[a];if(-1==u.exercises.indexOf(s))return o.reject("MES_EXERCISE"),o;var p=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===p.length)return o.reject("MES_EXERCISE"),o;p=p[0];var f=Db.getRefs().exercises[s],c=f.max*u.weight;if(WEIGHT_MIN>i||i>c)return o.reject("MES_WEIGHT"),o;if(REPEATS_MIN>n)return o.reject("MES_REPEATS_MIN"),o;if(n>REPEATS_MAX)return o.reject("MES_REPEATS_MAX"),o;var v={success:!0,id:s,weight:i,plan:n},d=module.exports.getTotalWeightMax(t,s);if(i>d&&f.energy>t["private"].energy)return o.reject("MES_ENERGY"),o;var E,l,g=module.exports.getRepeatsAndEff(t,s,i,d),M=n>0?n:g.repeatsMax,h=Math.floor(M<g.repeatsMax?M:g.repeatsMax);if(i>d)l=.5,E=f.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),E=Math.ceil(h/g.repeatsMax*f.energy),E>t["private"].energy)return o.reject("MES_ENERGY"),o;var y=g.weightEffect*repeatsEffect*.3*(h/g.repeatsMax);if(v.effect=y,v.fact=g.repeatsMax,v.energy=-E,h>=1){var _=p.pr||0;i>_&&(p&&(p.pr=i),v.pr=!0);var x=f.wr;i>(x?x.value:0)&&(f.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:f.wr}}),v.wr=!0)}return t["private"].energy-=E,setFrazzle(t,f,y),e.isDirty=!0,o.resolve(v),o}}};