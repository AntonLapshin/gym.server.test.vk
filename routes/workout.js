function setFrazzle(e,r,t){r.body.forEach(function(r){var a=e["private"].body[r._id],s=a.frazzle+r.stress*t;s>1&&(s=1);var i=a.stress+(r.stress<.5?r.stress/2:r.stress)*t;i>1&&(i=1),e["private"].body[r._id].frazzle=$.round(s),e["private"].body[r._id].stress=$.round(i)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=Db.getRefs().exercises[r],i=curve.getWeightMax(t,r),f=0,p=0;p<e["private"].stimul.length;p++){var n=e["private"].stimul[p],u=Db.getRefs().shop[2].items[n];f+=u.power}f>1&&(f=1),f/=5;for(var o=0,c=0,p=0;p<s.body.length;p++){var d=s.body[p],v=a[d._id],E=Db.getRefs().muscles[d._id],l=E.power*d.stress,g=l*v.frazzle;o+=l,c+=g}var M=c/o*.1,y=i+i*f-i*M;return y},getRepeatsAndEff:function(e,r,t,a){var s=curve.getRepeatsMax(e["public"].level,r,t,a),i=curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,s=r.rate,i=r.eff;if(a["private"].money<s)return t.resolve({success:!1}),t;var f={success:!0},p=a["private"].energy/a["private"].energyMax;return i=1-p*i,a["private"].body.forEach(function(e){e.frazzle+=$.round(i),e.stress+=$.round(i),e.frazzle>1&&(e.frazzle=1),e.stress>1&&(e.stress=1)}),e.isDirty=!0,f.effect=i,f.energy=-a["private"].energy,f.money=-s,a["private"].energy=0,t.resolve(f),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,f=r.repeats,p=$.Deferred(),n=Db.getRefs().gyms[a];if(-1==n.exercises.indexOf(s))return p.reject("MES_EXERCISE"),p;var u=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===u.length)return p.reject("MES_EXERCISE"),p;u=u[0];var o=Db.getRefs().exercises[s],c=o.max*n.weight;if(WEIGHT_MIN>i||i>c)return p.reject("MES_WEIGHT"),p;if(REPEATS_MIN>f)return p.reject("MES_REPEATS_MIN"),p;if(f>REPEATS_MAX)return p.reject("MES_REPEATS_MAX"),p;var d={success:!0,id:s,weight:i,plan:f},v=module.exports.getTotalWeightMax(t,s);if(i>v&&o.energy>t["private"].energy)return p.reject("MES_ENERGY"),p;var E,l,g=module.exports.getRepeatsAndEff(t,s,i,v),M=f>0?f:g.repeatsMax,y=Math.floor(M<g.repeatsMax?M:g.repeatsMax);if(i>v)l=.5,E=o.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),E=Math.ceil(y/g.repeatsMax*o.energy),E>t["private"].energy)return p.reject("MES_ENERGY"),p;var h=g.weightEffect*repeatsEffect*.3*(y/g.repeatsMax);if(d.effect=h,d.fact=g.repeatsMax,d.energy=-E,y>=1){var x=u.pr||0;i>x&&(u&&(u.pr=i),d.pr=!0);var _=o.wr;i>(_?_.value:0)&&(o.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:o.wr}}),d.wr=!0)}return t["private"].energy-=E,setFrazzle(t,o,h),e.isDirty=!0,p.resolve(d),p}}};