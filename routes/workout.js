function setFrazzle(e,r,t){r.body.forEach(function(r){var a=e["private"].body[r._id],s=a.frazzle+r.stress*t;s>1&&(s=1);var i=a.stress+(r.stress<.5?r.stress/2:r.stress)*t;i>1&&(i=1),e["private"].body[r._id].frazzle=$.round(s),e["private"].body[r._id].stress=$.round(i)})}var Db=require("../db"),$=require("jquery-deferred"),curve=require("../controllers/curve"),Coach=require("../controllers/coach"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].body,s=Db.getRefs().exercises[r],i=curve.getWeightMax(t,r),f=0,n=0;n<e["private"].stimul.length;n++){var p=e["private"].stimul[n],c=Db.getRefs().shop[2].items[p];f+=c.power}f>1&&(f=1),f/=5;for(var o=0,u=0,n=0;n<s.body.length;n++){var d=s.body[n],v=a[d._id],E=Db.getRefs().muscles[d._id],l=E.power*d.stress,g=l*v.frazzle;o+=l,u+=g}var M=u/o*.1,y=i+i*f-i*M;return y},getRepeatsAndEff:function(e,r,t,a){var s=curve.getRepeatsMax(e["public"].level,r,t,a),i=curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,s=r.rate,i=r.eff;if(a["private"].money<s)return t.resolve({success:!1}),t;var f={success:!0},n=a["private"].energy/a["private"].energyMax;return i=n*i,a["private"].body.forEach(function(e){e.frazzle+=$.round(i),e.stress+=$.round(i),e.frazzle>1&&(e.frazzle=1),e.stress>1&&(e.stress=1)}),e.isDirty=!0,f.effect=i,f.energy=-a["private"].energy,f.money=-s,a["private"].energy=0,Coach.earn(a["private"].coach,s),t.resolve(f),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.gymId,s=r.exerciseId,i=r.weight,f=r.repeats,n=$.Deferred(),p=Db.getRefs().gyms[a];if(-1==p.exercises.indexOf(s))return n.reject("MES_EXERCISE"),n;var c=$.grep(t["public"].exercises,function(e){return e._id===s});if(0===c.length)return n.reject("MES_EXERCISE"),n;c=c[0];var o=Db.getRefs().exercises[s],u=o.max*p.weight;if(WEIGHT_MIN>i||i>u)return n.reject("MES_WEIGHT"),n;if(REPEATS_MIN>f)return n.reject("MES_REPEATS_MIN"),n;if(f>REPEATS_MAX)return n.reject("MES_REPEATS_MAX"),n;var d={success:!0,id:s,weight:i,plan:f},v=module.exports.getTotalWeightMax(t,s);if(i>v&&o.energy>t["private"].energy)return n.reject("MES_ENERGY"),n;var E,l,g=module.exports.getRepeatsAndEff(t,s,i,v),M=f>0?f:g.repeatsMax,y=Math.floor(M<g.repeatsMax?M:g.repeatsMax);if(i>v)l=.5,E=o.energy;else if(repeatsEffect=curve.getRepeatsEffect(M),E=Math.ceil(y/g.repeatsMax*o.energy),E>t["private"].energy)return n.reject("MES_ENERGY"),n;var h=g.weightEffect*repeatsEffect*.3*(y/g.repeatsMax);if(d.effect=h,d.fact=g.repeatsMax,d.energy=-E,y>=1){var x=c.pr||0;i>x&&(c&&(c.pr=i),d.pr=!0);var _=o.wr;i>(_?_.value:0)&&(o.wr={value:i,_id:t._id},Db.update("exercises",s,{$set:{wr:o.wr}}),d.wr=!0)}return t["private"].energy-=E,setFrazzle(t,o,h),e.isDirty=!0,n.resolve(d),n}}};